!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.MetalitixLogger=e():t.MetalitixLogger=e()}(self,(()=>(()=>{"use strict";var t={d:(e,s)=>{for(var o in s)t.o(s,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:s[o]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)},e={};t.d(e,{default:()=>d});const s=[];for(let t=0;t<256;t++)s[t]=(t<16?"0":"")+t.toString(16);Math.PI,Math.PI;const o=500;var i;function n(t,e){const s=Object.keys,o=typeof t;return t&&e&&"object"===o&&o===typeof e?s(t).length===s(e).length&&s(t).every((s=>n(t[s],e[s]))):t===e}!function(t){let e,s,o;!function(t){t.Pressed="state.pressed",t.Updated="state.updated",t.Released="state.released",t.Stationary="state.stationary"}(e=t.PointStates||(t.PointStates={})),t.KnownPointStates=Object.values(e),function(t){t.KeyDown="user.interaction.key_down",t.KeyPress="user.interaction.key_press",t.KeyUp="user.interaction.key_down",t.MouseEnter="user.interaction.mouse_enter",t.MouseLeave="user.interaction.mouse_leave",t.MouseOver="user.interaction.mouse_over",t.MouseOut="user.interaction.mouse_out",t.MouseDown="user.interaction.mouse_down",t.MouseUp="user.interaction.mouse_up",t.MouseMove="user.interaction.mouse_move",t.MousePress="user.interaction.mouse_press",t.TouchTap="user.interaction.touch_tap",t.TouchStart="user.interaction.touch_start",t.TouchMove="user.interaction.touch_move",t.TouchEnd="user.interaction.touch_end",t.ZoomStart="user.interaction.zoom_start",t.ZoomUpdate="user.interaction.zoom_update",t.ZoomEnd="user.interaction.zoom_end"}(s=t.UserInteractionTypes||(t.UserInteractionTypes={})),t.KnownUserInteractionTypes=Object.values(s),function(t){t.UserPosition="event.user.position",t.UserInteraction="event.user.interaction",t.SessionStart="event.session.start",t.SessionUpdate="event.session.update",t.SessionEnd="event.session.end"}(o=t.EventTypes||(t.EventTypes={})),t.KnownEventTypes=Object.values(o)}(i||(i={}));var a=function(t,e,s,o){return new(s||(s=Promise))((function(i,n){function a(t){try{d(o.next(t))}catch(t){n(t)}}function r(t){try{d(o.throw(t))}catch(t){n(t)}}function d(t){var e;t.done?i(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(a,r)}d((o=o.apply(t,e||[])).next())}))};class r{constructor(t,e={}){this.interval=o,this.customData={},this.object3D=null,this.setPollInterval=t=>{this.interval=Math.min(1e3,Math.max(100,t))},this.setCustomField=(t,e)=>{this.customData[t]=e},this.removeCustomField=t=>{delete this.customData[t]},this.getRecord=(t,e,{userEvent:s,userMeta:o,camera:n,data:a})=>{const r=Object.assign({},this.customData,a),d={object:"xr.analytics.record",appkey:this.appKey,apiver:this.apiVersion,sessionId:e,timestamp:Date.now(),data:r};if(t===i.EventTypes.SessionStart)return console.assert(void 0!==o,'"userMeta" is required for session start!'),console.assert(void 0!==n,'"camera" is required for session start!'),Object.assign({},d,{eventType:t,userMeta:o,camera:n});if(t===i.EventTypes.SessionUpdate)return console.assert(void 0!==o,'"userMeta" is required for session update!'),Object.assign({},d,{eventType:t,userMeta:o,camera:n});if(t===i.EventTypes.SessionEnd)return Object.assign({},d,{eventType:t,camera:n});if(t===i.EventTypes.UserPosition)return Object.assign({},d,{eventType:t});if(t===i.EventTypes.UserInteraction)return console.assert(void 0!==s,'"userEvent" is required for user interaction!'),Object.assign({},d,{eventType:t,userEvent:s});throw new Error("Unknown eventType: "+t)},this.addRecord=(t,{userEvent:e,userMeta:s,camera:o,data:i})=>{if(null===this.sessionId)return;const n=this.getRecord(t,this.sessionId,{userEvent:e,userMeta:s,camera:o,data:i});this.pollRecords.push(n)},this.sendPosition=(t=!1)=>a(this,void 0,void 0,(function*(){this.pollInProgress=!0;try{const e=this.pollRecords.slice(0,100),s={object:"xr.analytics.batch.records",appkey:this.appKey,apiver:this.apiVersion,items:e};yield function(t){return e=this,s=void 0,i=function*(){return console.log("poll",t),fetch("https://app.metalitix.com/api/v1/xr-analytics",{method:"POST",keepalive:!0,headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})},new((o=void 0)||(o=Promise))((function(t,n){function a(t){try{d(i.next(t))}catch(t){n(t)}}function r(t){try{d(i.throw(t))}catch(t){n(t)}}function d(e){var s;e.done?t(e.value):(s=e.value,s instanceof o?s:new o((function(t){t(s)}))).then(a,r)}d((i=i.apply(e,s||[])).next())}));var e,s,o,i}(s),this.pollRecords=this.pollRecords.slice(100),this.pollRecords.length>0&&t&&(yield this.sendPosition(!0)),this.lastPollTimestamp=Date.now()}catch(t){console.log("Something went wrong",t),this.forceStopLoop()}finally{this.pollInProgress=!1}})),this.getUserMeta=()=>Object.assign({},this.userMeta,{userAgent:window.navigator.userAgent,pagePath:location.pathname,pageQuery:location.search}),this.addSessionStart=()=>{const t=this.getPositionData(this.object3D),e=this.getCameraData(this.object3D),s=this.getUserMeta();this.previousCameraData=e||null,void 0!==t&&this.addRecord(i.EventTypes.SessionStart,{data:t,camera:e,userMeta:s})},this.addSessionEnd=()=>{const t=this.getPositionData(this.object3D);let e=this.getCameraData(this.object3D);void 0!==t&&(n(e,this.previousCameraData)&&(e=void 0),this.addRecord(i.EventTypes.SessionEnd,{data:t,camera:e}))},this.addUserPosition=()=>{const t=this.getPositionData(this.object3D);void 0!==t&&this.addRecord(i.EventTypes.UserPosition,{data:t})},this.addSessionUpdate=t=>{const e=this.getPositionData(this.object3D),s=this.getUserMeta();void 0!==e&&this.addRecord(i.EventTypes.SessionUpdate,{data:e,camera:t,userMeta:s})},this.sddNextUserPositionAndUpdateCameraIfNeeded=()=>{const t=this.getCameraData(this.object3D);void 0===t||n(t,this.previousCameraData)?this.addUserPosition():(this.addSessionUpdate(t),this.previousCameraData=t)},this.sendPositionLoop=(t=!1)=>{t||this.sddNextUserPositionAndUpdateCameraIfNeeded(),!this.pollInProgress&&this.pollRecords.length>0&&(this.pollRecords.length>=100||Date.now()-this.lastPollTimestamp>=18e4)&&this.sendPosition(),null===this.sessionId&&0===this.pollRecords.length||(this.nextPoll=window.setTimeout((()=>this.sendPositionLoop()),this.interval))},this.forceStopLoop=()=>clearTimeout(this.nextPoll),this.clearSessionPollRecords=()=>{this.pollRecords=[]},this.handleVisibilityChange=()=>a(this,void 0,void 0,(function*(){return"hidden"===document.visibilityState?this.pauseSession():yield this.resumeSession()})),this.startSession=t=>{this.object3D=t,this.sessionId=function(){const t=4294967295*Math.random()|0,e=4294967295*Math.random()|0,o=4294967295*Math.random()|0,i=4294967295*Math.random()|0;return(s[255&t]+s[t>>8&255]+s[t>>16&255]+s[t>>24&255]+"-"+s[255&e]+s[e>>8&255]+"-"+s[e>>16&15|64]+s[e>>24&255]+"-"+s[63&o|128]+s[o>>8&255]+"-"+s[o>>16&255]+s[o>>24&255]+s[255&i]+s[i>>8&255]+s[i>>16&255]+s[i>>24&255]).toUpperCase()}(),this.addSessionStart(),this.sendPositionLoop(!0),document.addEventListener("visibilitychange",this.handleVisibilityChange)},this.pauseSession=()=>(this.forceStopLoop(),this.sendPosition(!0)),this.resumeSession=()=>a(this,void 0,void 0,(function*(){if(this.lastPollTimestamp<0||Date.now()-this.lastPollTimestamp<=3e5)this.forceStopLoop(),this.sendPositionLoop();else if(null!==this.object3D){const t=this.object3D;yield this.endSession(),this.startSession(t)}})),this.endSession=()=>a(this,void 0,void 0,(function*(){null!==this.sessionId&&(this.addSessionEnd(),this.object3D=null,this.sessionId=null,this.previousCameraData=null,this.forceStopLoop(),yield this.sendPosition(!0),this.clearSessionPollRecords(),this.lastPollTimestamp=-1,document.removeEventListener("visibilitychange",this.handleVisibilityChange))})),this.updateUserMeta=t=>{void 0!==t&&(this.userMeta=t,this.addSessionUpdate())},this.sendUserEvent=(t,e,s,o,n)=>{const a=this.getPositionData(this.object3D),r={object:"user.event",eventName:t,eventType:e,target:s,points:o,params:n};void 0!==a&&this.addRecord(i.EventTypes.UserInteraction,{data:a,userEvent:r})},this.logCustomEvent=(t,e)=>{this.sendUserEvent(t,"custom",void 0,void 0,e)},this.logKeyDownEvent=(t,e,s)=>{this.sendUserEvent("key_down",i.UserInteractionTypes.KeyDown,{state:i.PointStates.Pressed,timestamp:Date.now(),position:{x:t,y:e}},void 0,s)},this.logKeyPressEvent=(t,e,s)=>{this.sendUserEvent("key_press",i.UserInteractionTypes.KeyPress,{state:i.PointStates.Stationary,timestamp:Date.now(),position:{x:t,y:e}},void 0,s)},this.logKeyUpEvent=(t,e,s)=>{this.sendUserEvent("key_up",i.UserInteractionTypes.KeyUp,{state:i.PointStates.Released,timestamp:Date.now(),position:{x:t,y:e}},void 0,s)},this.logMouseEnterEvent=(t,e,s)=>{this.sendUserEvent("mouse_enter",i.UserInteractionTypes.MouseEnter,{state:i.PointStates.Stationary,timestamp:Date.now(),position:{x:t,y:e}},void 0,s)},this.logMouseLeaveEvent=(t,e,s)=>{this.sendUserEvent("mouse_leave",i.UserInteractionTypes.MouseLeave,{state:i.PointStates.Stationary,timestamp:Date.now(),position:{x:t,y:e}},void 0,s)},this.logMouseOverEvent=(t,e,s)=>{this.sendUserEvent("mouse_over",i.UserInteractionTypes.MouseOver,{state:i.PointStates.Stationary,timestamp:Date.now(),position:{x:t,y:e}},void 0,s)},this.logMouseOutEvent=(t,e,s)=>{this.sendUserEvent("mouse_out",i.UserInteractionTypes.MouseOut,{state:i.PointStates.Stationary,timestamp:Date.now(),position:{x:t,y:e}},void 0,s)},this.logMouseDownEvent=(t,e,s)=>{this.sendUserEvent("mouse_down",i.UserInteractionTypes.MouseDown,{state:i.PointStates.Pressed,timestamp:Date.now(),position:{x:t,y:e}},void 0,s)},this.logMouseUpEvent=(t,e,s)=>{this.sendUserEvent("mouse_up",i.UserInteractionTypes.MouseUp,{state:i.PointStates.Released,timestamp:Date.now(),position:{x:t,y:e}},void 0,s)},this.logMouseMoveEvent=(t,e,s)=>{this.sendUserEvent("mouse_move",i.UserInteractionTypes.MouseMove,{state:i.PointStates.Updated,timestamp:Date.now(),position:{x:t,y:e}},void 0,s)},this.logMousePressEvent=(t,e,s)=>{this.sendUserEvent("mouse_press",i.UserInteractionTypes.MousePress,{state:i.PointStates.Stationary,timestamp:Date.now(),position:{x:t,y:e}},void 0,s)},this.logTouchTapEvent=(t,e,s)=>{this.sendUserEvent("touch_tap",i.UserInteractionTypes.TouchTap,{state:i.PointStates.Stationary,timestamp:Date.now(),position:{x:t,y:e}},void 0,s)},this.logTouchStartEvent=(t,e,s)=>{this.sendUserEvent("touch_start",i.UserInteractionTypes.TouchStart,{state:i.PointStates.Pressed,timestamp:Date.now(),position:{x:t,y:e}},void 0,s)},this.logTouchMoveEvent=(t,e,s)=>{this.sendUserEvent("touch_move",i.UserInteractionTypes.TouchMove,{state:i.PointStates.Updated,timestamp:Date.now(),position:{x:t,y:e}},void 0,s)},this.logTouchEndEvent=(t,e,s)=>{this.sendUserEvent("touch_end",i.UserInteractionTypes.TouchEnd,{state:i.PointStates.Released,timestamp:Date.now(),position:{x:t,y:e}},void 0,s)},this.logZoomStartEvent=(t,e,s)=>{this.sendUserEvent("zoom_start",i.UserInteractionTypes.ZoomStart,{state:i.PointStates.Pressed,timestamp:Date.now(),position:{x:t,y:e}},void 0,s)},this.logZoomUpdateEvent=(t,e,s)=>{this.sendUserEvent("zoom_update",i.UserInteractionTypes.ZoomUpdate,{state:i.PointStates.Updated,timestamp:Date.now(),position:{x:t,y:e}},void 0,s)},this.logZoomEndEvent=(t,e,s)=>{this.sendUserEvent("zoom_end",i.UserInteractionTypes.ZoomEnd,{state:i.PointStates.Released,timestamp:Date.now(),position:{x:t,y:e}},void 0,s)};const{pollInterval:r=o,apiVersion:d="v2",userMeta:h={}}=e;this.appKey=t,this.apiVersion=d,this.userMeta=h,this.setPollInterval(r),this.sessionId=null,this.previousCameraData=null,this.pollRecords=[],this.lastPollTimestamp=-1,this.pollInProgress=!1,this.nextPoll=-1}}class d extends r{constructor(t,e={}){super(t,e),this.getPositionData=t=>{var e;const s=null!==(e=null==t?void 0:t.activeCamera)&&void 0!==e?e:null;if(null!==s)return{position:{x:s.position.x,y:s.position.y,z:s.position.z},direction:{x:s.absoluteRotation.x,y:s.absoluteRotation.y,z:s.absoluteRotation.z}}},this.getCameraData=t=>{var e;const s=null!==(e=null==t?void 0:t.activeCamera)&&void 0!==e?e:null;if(null!==s)return{fieldOfView:s.fov,aspectRatio:s.viewport.width/s.viewport.height,zNearPlane:s.minZ,zFarPlane:s.maxZ}}}}return e.default})()));
//# sourceMappingURL=mtx-poll-babylon-js.js.map